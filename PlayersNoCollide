
local checkpoints = workspace:WaitForChild("Checkpoints")
local DataStoreService = game:GetService("DataStoreService")
local DataStore = DataStoreService:GetDataStore("ObbyDataStore")



game.Players.PlayerAdded:Connect(function(player)	
	
	local data = DataStore:GetAsync(player.UserId.."-Stage")
	
	local leaderstats = Instance.new("Folder")
	leaderstats.Name = "leaderstats"
	leaderstats.Parent = player

	local Stage = Instance.new("IntValue")
	Stage.Name = "Stage"
	Stage.Parent = leaderstats
	if data then
		Stage.Value = data
	else
		Stage.Value = 1
	end
	
	
	
	local success, errormessage = pcall(function()

	end)

	if success then
		if data then
			player.leaderstats.Stage.Value = data
			print("Success")
		else
			print("There was an error")
			player.leaderstats.Stage.Value = 1
		end
	else
		print("There was an error when recieving your save data")
		warn(errormessage)
		player.leaderstats.Stage.Value = 1
	end
	

	player.CharacterAdded:Connect(function(char)
	
		local hum = char:WaitForChild("Humanoid")
		wait()
		if data then 
			char:MoveTo(checkpoints[Stage.Value].Position)
			print("You Have saved data")
		else
			char:MoveTo(checkpoints[1].Position)
			print("you have no data")
		end
		
		
			
		hum.Touched:Connect(function(hit)
			if hit.Parent == checkpoints then
				if tonumber(hit.Name) > Stage.Value then
					Stage.Value = hit.Name
					data = Stage.Value

				
				
				

						--End of Save in tp
					
				end
			end
		end)
	end)
end)
	
	

game.Players.PlayerRemoving:Connect(function(player)
	local success, errormessage = pcall(function()
		DataStore:SetAsync(player.UserId.."-Stage",player.leaderstats.Stage.Value)
		
	end)
	if success then
		print("Player Data successfully Saved!")
	else
		print("There was an error saving your data")
		warn(errormessage)
	end
end)

